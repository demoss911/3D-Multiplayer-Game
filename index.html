<!DOCTYPE html>
<html>
<head>
    <title>3D Multiplayer Prototype</title>
    <style> 
        body { margin: 0; overflow: hidden; background-color: #87CEEB; font-family: 'Segoe UI', Tahoma, sans-serif; } 
        
        /* UI Containers */
        #top-ui { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.6); color: white; padding: 12px; border-radius: 8px; pointer-events: none; }
        
        /* Instructions Overlay */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100; color: white; text-align: center;
        }

        /* Chat System */
        #chat-container {
            position: absolute; bottom: 20px; left: 20px; width: 300px;
            background: rgba(0,0,0,0.6); border-radius: 8px; display: flex; flex-direction: column;
        }
        #chat-box { height: 150px; overflow-y: auto; padding: 10px; color: white; font-size: 14px; display: flex; flex-direction: column; gap: 5px; }
        #chat-input { background: rgba(255,255,255,0.1); border: none; padding: 10px; color: white; outline: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        
        .btn { background: #0a66c2; color: white; border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 20px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>

<div id="overlay">
    <h1>3D Multiplayer Prototype</h1>
    <p><strong>Move:</strong> W, A, S, D keys<br><strong>Chat:</strong> Type in the box below</p>
    <button class="btn" onclick="startGame()">START SESSION</button>
</div>

<div id="top-ui">
    <div style="font-size: 12px; opacity: 0.7;">SERVER: <span id="status" style="color: #ff4444;">OFFLINE</span></div>
    <div style="font-size: 18px; font-weight: bold;">Players: <span id="player-count">0</span></div>
</div>

<div id="chat-container">
    <div id="chat-box"></div>
    <input id="chat-input" placeholder="Press Enter to chat..." autocomplete="off">
</div>

<script>
    const SERVER_URL = "https://multiplayer-backend-uz4n.onrender.com"; 
    const socket = io(SERVER_URL);
    
    // UI Elements
    const statusEl = document.getElementById('status');
    const countEl = document.getElementById('player-count');
    const chatBox = document.getElementById('chat-box');
    const chatInput = document.getElementById('chat-input');

    function startGame() {
        document.getElementById('overlay').style.display = 'none';
    }

    // --- CHAT LOGIC ---
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && chatInput.value.trim() !== "") {
            socket.emit('chat-message', chatInput.value);
            chatInput.value = "";
        }
    });

    socket.on('chat-message', (data) => {
        const msg = document.createElement('div');
        msg.innerHTML = `<span style="color:${data.color}">Player:</span> ${data.text}`;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // --- CONNECTION & 3D LOGIC ---
    socket.on('connect', () => { statusEl.innerText = "ONLINE"; statusEl.style.color = "#44ff44"; });
    socket.on('disconnect', () => { statusEl.innerText = "OFFLINE"; statusEl.style.color = "#ff4444"; });

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const floor = new THREE.Mesh(new THREE.PlaneGeometry(50, 50), new THREE.MeshBasicMaterial({ color: 0x333333 }));
    floor.rotation.x = -Math.PI / 2;
    scene.add(floor);
    camera.position.set(0, 10, 20);
    camera.lookAt(0, 0, 0);

    const otherPlayers = {}; 
    let myMesh; 

    function updatePlayerCount() {
        countEl.innerText = Object.keys(otherPlayers).length + (myMesh ? 1 : 0);
    }

    socket.on('currentPlayers', (players) => {
        Object.keys(players).forEach((id) => {
            const geometry = new THREE.BoxGeometry(1, 2, 1);
            const material = new THREE.MeshBasicMaterial({ color: players[id].color });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(players[id].x, players[id].y, players[id].z);
            scene.add(mesh);
            if (id === socket.id) myMesh = mesh; else otherPlayers[id] = mesh;
        });
        updatePlayerCount();
    });

    socket.on('newPlayer', (data) => {
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshBasicMaterial({ color: data.player.color }));
        mesh.position.set(data.player.x, data.player.y, data.player.z);
        scene.add(mesh);
        otherPlayers[data.id] = mesh;
        updatePlayerCount();
    });

    socket.on('playerMoved', (data) => {
        if (otherPlayers[data.id]) {
            otherPlayers[data.id].position.x = data.x;
            otherPlayers[data.id].position.z = data.z;
        }
    });

    socket.on('playerDisconnected', (id) => {
        if (otherPlayers[id]) { scene.remove(otherPlayers[id]); delete otherPlayers[id]; updatePlayerCount(); }
    });

    const speed = 0.2;
    const keys = {};
    window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

    function animate() {
        requestAnimationFrame(animate);
        if (myMesh && document.activeElement !== chatInput) {
            let moved = false;
            if (keys['w']) { myMesh.position.z -= speed; moved = true; }
            if (keys['s']) { myMesh.position.z += speed; moved = true; }
            if (keys['a']) { myMesh.position.x -= speed; moved = true; }
            if (keys['d']) { myMesh.position.x += speed; moved = true; }
            if (moved) socket.emit('playerMovement', { x: myMesh.position.x, z: myMesh.position.z });
        }
        renderer.render(scene, camera);
    }
    animate();
</script>
</body>
</html>
